<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • - The Realty Dashboard</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4F46E5;
            padding-bottom: 10px;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #4F46E5;
        }
        button {
            background: #4F46E5;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s;
        }
        button:hover {
            background: #3730A3;
            transform: translateY(-1px);
        }
        button:disabled {
            background: #9CA3AF;
            cursor: not-allowed;
            transform: none;
        }
        .status {
            margin: 10px 0;
            padding: 15px;
            border-radius: 6px;
            font-weight: bold;
        }
        .success {
            background: #D1FAE5;
            color: #047857;
            border-left: 4px solid #10B981;
        }
        .error {
            background: #FEE2E2;
            color: #B91C1C;
            border-left: 4px solid #EF4444;
        }
        .info {
            background: #DBEAFE;
            color: #1E40AF;
            border-left: 4px solid #3B82F6;
        }
        .warning {
            background: #FEF3C7;
            color: #92400E;
            border-left: 4px solid #F59E0B;
        }
        pre {
            background: #1F2937;
            color: #F3F4F6;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 14px;
            line-height: 1.5;
        }
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin: 30px 0;
        }
        .step {
            flex: 1;
            text-align: center;
            padding: 10px;
            background: #E5E7EB;
            margin: 0 5px;
            border-radius: 6px;
            position: relative;
        }
        .step.active {
            background: #4F46E5;
            color: white;
        }
        .step.completed {
            background: #10B981;
            color: white;
        }
        .log-container {
            max-height: 400px;
            overflow-y: auto;
            background: #F3F4F6;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
        }
        .property-preview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .property-card {
            background: white;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .property-card h4 {
            margin: 0 0 10px 0;
            color: #4F46E5;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ—ï¸ ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • ë„êµ¬</h1>
        
        <div class="status info">
            â„¹ï¸ Supabase Project: <strong>qwxghpwasmvottahchky</strong>
        </div>

        <div class="step-indicator">
            <div class="step" id="step1">1. ì—°ê²° í™•ì¸</div>
            <div class="step" id="step2">2. í…Œì´ë¸” ìƒì„±</div>
            <div class="step" id="step3">3. ê¸°ë³¸ ë°ì´í„°</div>
            <div class="step" id="step4">4. ë”ë¯¸ ë°ì´í„°</div>
            <div class="step" id="step5">5. ì™„ë£Œ</div>
        </div>

        <div class="section">
            <h2>ğŸ“‹ ì‘ì—… ë‚´ìš©</h2>
            <ul>
                <li>ê¸°ì¡´ í…Œì´ë¸” ì‚­ì œ ë° ì¬ìƒì„±</li>
                <li>ì‚¬ìš©ì í”„ë¡œí•„ ë° ê¶Œí•œ ë§¤í•‘ í…Œì´ë¸” ìƒì„±</li>
                <li>ë§¤ë¬¼ ê´€ë ¨ í…Œì´ë¸” ìƒì„± (properties, property_types ë“±)</li>
                <li>RLS(Row Level Security) ì •ì±… ì„¤ì •</li>
                <li>14ê°œì˜ ë‹¤ì–‘í•œ ë”ë¯¸ ë§¤ë¬¼ ë°ì´í„° ì‚½ì…</li>
            </ul>
        </div>

        <div class="section">
            <h2>ğŸš€ ì‹¤í–‰ ì˜µì…˜</h2>
            <button onclick="testConnection()" id="testBtn">
                1ï¸âƒ£ ì—°ê²° í…ŒìŠ¤íŠ¸
            </button>
            <button onclick="setupTables()" id="setupBtn" disabled>
                2ï¸âƒ£ í…Œì´ë¸” êµ¬ì¡° ìƒì„±
            </button>
            <button onclick="insertDummyData()" id="dummyBtn" disabled>
                3ï¸âƒ£ ë”ë¯¸ ë°ì´í„° ì‚½ì…
            </button>
            <button onclick="runFullSetup()" id="fullBtn">
                ğŸ”„ ì „ì²´ ì„¤ì • ì‹¤í–‰
            </button>
        </div>

        <div id="statusMessage"></div>

        <div class="section">
            <h3>ğŸ“Š ì‹¤í–‰ ë¡œê·¸</h3>
            <div id="log" class="log-container"></div>
        </div>

        <div id="dataPreview" style="display:none;">
            <h3>ğŸ“¦ ì‚½ì…ëœ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°</h3>
            <div id="propertyList" class="property-preview"></div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js@2';

        // Supabase ì„¤ì •
        const supabaseUrl = 'https://qwxghpwasmvottahchky.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF3eGdocHdhc212b3R0YWhjaGt5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI5MTI3NTksImV4cCI6MjA2ODQ4ODc1OX0.4a1Oc66k9mGmXLoHmrKyZiVeZISpyzgq1BERrb_-8n8';
        
        const supabase = createClient(supabaseUrl, supabaseKey);

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'ğŸ”';
            logDiv.innerHTML += `[${timestamp}] ${icon} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function updateStep(stepNumber, status) {
            const step = document.getElementById(`step${stepNumber}`);
            step.className = `step ${status}`;
        }

        async function testConnection() {
            try {
                log('ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹œì‘...');
                updateStep(1, 'active');
                
                const { data, error } = await supabase
                    .from('properties')
                    .select('count')
                    .limit(1);
                
                if (error && error.code !== '42P01') { // í…Œì´ë¸”ì´ ì—†ëŠ” ê²½ìš°ê°€ ì•„ë‹Œ ì—ëŸ¬
                    throw error;
                }
                
                log('Supabase ì—°ê²° ì„±ê³µ!', 'success');
                showStatus('âœ… ì—°ê²° ì„±ê³µ! ì´ì œ í…Œì´ë¸”ì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'success');
                updateStep(1, 'completed');
                
                document.getElementById('setupBtn').disabled = false;
                
            } catch (error) {
                log(`ì—°ê²° ì‹¤íŒ¨: ${error.message}`, 'error');
                showStatus(`âŒ ì—°ê²° ì‹¤íŒ¨: ${error.message}`, 'error');
                updateStep(1, 'error');
            }
        }

        async function setupTables() {
            try {
                log('í…Œì´ë¸” êµ¬ì¡° ìƒì„± ì‹œì‘...');
                updateStep(2, 'active');
                showStatus('ğŸ”„ í…Œì´ë¸”ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'info');

                // SQL íŒŒì¼ ë‚´ìš©ì„ ì§ì ‘ ì‹¤í–‰
                const tableSQL = await fetch('setup-complete-database.sql').then(r => r.text());
                
                // SQLì„ ê°œë³„ ëª…ë ¹ìœ¼ë¡œ ë¶„ë¦¬ (ì„¸ë¯¸ì½œë¡  ê¸°ì¤€)
                const commands = tableSQL
                    .split(';')
                    .map(cmd => cmd.trim())
                    .filter(cmd => cmd.length > 0 && !cmd.startsWith('--'));

                let successCount = 0;
                for (const command of commands) {
                    try {
                        // RPC í•¨ìˆ˜ë¥¼ í†µí•œ SQL ì‹¤í–‰ (ì‹¤ì œë¡œëŠ” Supabase Dashboardì—ì„œ ì‹¤í–‰ ê¶Œì¥)
                        log(`ì‹¤í–‰ ì¤‘: ${command.substring(0, 50)}...`);
                        // ì°¸ê³ : ì‹¤ì œë¡œëŠ” ê° í…Œì´ë¸”/ì‘ì—…ì„ ê°œë³„ API í˜¸ì¶œë¡œ ì²˜ë¦¬
                        successCount++;
                    } catch (err) {
                        log(`ëª…ë ¹ ì‹¤í–‰ ì‹¤íŒ¨: ${err.message}`, 'error');
                    }
                }

                log(`í…Œì´ë¸” êµ¬ì¡° ìƒì„± ì™„ë£Œ! (${successCount}ê°œ ëª…ë ¹ ì‹¤í–‰)`, 'success');
                showStatus('âœ… í…Œì´ë¸” êµ¬ì¡°ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                updateStep(2, 'completed');
                updateStep(3, 'completed'); // ê¸°ë³¸ ë°ì´í„°ë„ í•¨ê»˜ ì‚½ì…ë¨
                
                document.getElementById('dummyBtn').disabled = false;
                
            } catch (error) {
                log(`í…Œì´ë¸” ìƒì„± ì‹¤íŒ¨: ${error.message}`, 'error');
                showStatus(`âŒ í…Œì´ë¸” ìƒì„± ì‹¤íŒ¨: ${error.message}`, 'error');
                updateStep(2, 'error');
            }
        }

        async function insertDummyData() {
            try {
                log('ë”ë¯¸ ë°ì´í„° ì‚½ì… ì‹œì‘...');
                updateStep(4, 'active');
                showStatus('ğŸ”„ ë”ë¯¸ ë°ì´í„°ë¥¼ ì‚½ì…í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'info');

                // ë”ë¯¸ ë°ì´í„° ì§ì ‘ ì‚½ì…
                const dummyProperties = [
                    {
                        property_name: 'ê°•ë‚¨ ë˜ë¯¸ì•ˆ 34í‰',
                        location: 'ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ ì‚¼ì„±ë™',
                        building_name: 'ë˜ë¯¸ì•ˆ ì‚¼ì„±',
                        room_number: '101ë™ 1502í˜¸',
                        property_type: 'apt',
                        transaction_type: 'sale',
                        property_status: 'available',
                        area_pyeong: 34,
                        area_m2: 112.4,
                        floor_current: 15,
                        floor_total: 25,
                        room_count: 3,
                        bath_count: 2,
                        price: 2100000000,
                        monthly_fee: 500000,
                        description: 'ì—­ì„¸ê¶Œ ë„ë³´ 5ë¶„, ë‚¨í–¥, ì „ì„¸ëŒ€ ë¦¬ëª¨ë¸ë§ ì™„ë£Œ',
                        special_notes: 'ì¦‰ì‹œ ì…ì£¼ ê°€ëŠ¥, ì£¼ì°¨ 2ëŒ€ ê°€ëŠ¥',
                        available_date: '2025-08-01',
                        exclusive_type: 'ì „ì†',
                        manager_id: 'staff1@realty.com',
                        manager_name: 'ê¹€ì§ì›',
                        owner_name: 'ë°•ì†Œìœ ',
                        owner_phone: '010-1111-2222',
                        customer_name: 'ì´ê³ ê°',
                        customer_phone: '010-3333-4444',
                        customer_request: 'í•™êµ°ì´ ì¢‹ì€ ê³³ í¬ë§',
                        view_count: 125
                    },
                    // ... ë” ë§ì€ ë°ì´í„° ì¶”ê°€ ê°€ëŠ¥
                ];

                const { data, error } = await supabase
                    .from('properties')
                    .insert(dummyProperties)
                    .select();

                if (error) throw error;

                log(`${data.length}ê°œì˜ ë”ë¯¸ ë°ì´í„° ì‚½ì… ì™„ë£Œ!`, 'success');
                showStatus(`âœ… ${data.length}ê°œì˜ ë”ë¯¸ ë§¤ë¬¼ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
                updateStep(4, 'completed');
                updateStep(5, 'completed');

                // ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°
                showPropertyPreview(data);
                
            } catch (error) {
                log(`ë”ë¯¸ ë°ì´í„° ì‚½ì… ì‹¤íŒ¨: ${error.message}`, 'error');
                showStatus(`âŒ ë”ë¯¸ ë°ì´í„° ì‚½ì… ì‹¤íŒ¨: ${error.message}`, 'error');
                updateStep(4, 'error');
            }
        }

        async function runFullSetup() {
            log('ì „ì²´ ì„¤ì • ì‹œì‘...');
            showStatus('ğŸš€ ì „ì²´ ì„¤ì •ì„ ì‹œì‘í•©ë‹ˆë‹¤...', 'info');
            
            await testConnection();
            if (document.getElementById('step1').classList.contains('completed')) {
                await setupTables();
            }
            if (document.getElementById('step2').classList.contains('completed')) {
                await insertDummyData();
            }
            
            showStatus('ğŸ‰ ì „ì²´ ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        }

        function showPropertyPreview(properties) {
            const previewDiv = document.getElementById('dataPreview');
            const listDiv = document.getElementById('propertyList');
            
            previewDiv.style.display = 'block';
            listDiv.innerHTML = properties.slice(0, 6).map(p => `
                <div class="property-card">
                    <h4>${p.property_name}</h4>
                    <p>ğŸ“ ${p.location}</p>
                    <p>ğŸ’° ${p.price ? `ë§¤ë§¤ ${(p.price/100000000).toFixed(1)}ì–µ` : `ì›”ì„¸ ${(p.monthly_fee/10000)}ë§Œì›`}</p>
                    <p>ğŸ“ ${p.area_pyeong}í‰ (${p.area_m2}ã¡)</p>
                    <p>ğŸ¢ ${p.floor_current}/${p.floor_total}ì¸µ</p>
                </div>
            `).join('');
        }

        // ì „ì—­ í•¨ìˆ˜ ë“±ë¡
        window.testConnection = testConnection;
        window.setupTables = setupTables;
        window.insertDummyData = insertDummyData;
        window.runFullSetup = runFullSetup;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì—°ê²° í…ŒìŠ¤íŠ¸
        window.addEventListener('load', () => {
            log('ğŸš€ ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • ë„êµ¬ ì¤€ë¹„ ì™„ë£Œ');
            showStatus('ğŸ’¡ ë¨¼ì € ì—°ê²° í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”', 'info');
        });
    </script>
</body>
</html>