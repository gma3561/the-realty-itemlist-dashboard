<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§¤ë¬¼ ë°ì´í„° ì—…ë¡œë“œ</title>
</head>
<body>
    <h1>ë§¤ë¬¼ ë°ì´í„° Supabase ì—…ë¡œë“œ</h1>
    <div id="status">ì´ˆê¸°í™” ì¤‘...</div>
    <div id="progress"></div>
    <pre id="log"></pre>
    <button id="startBtn" onclick="startUpload()">ì—…ë¡œë“œ ì‹œì‘</button>

    <script>
        const log = document.getElementById('log');
        const statusDiv = document.getElementById('status');
        const progressDiv = document.getElementById('progress');
        
        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            log.textContent += `[${timestamp}] ${message}\n`;
            log.scrollTop = log.scrollHeight;
            console.log(message);
        }
        
        function updateStatus(message) {
            statusDiv.textContent = message;
            addLog(`ìƒíƒœ: ${message}`);
        }
        
        function updateProgress(current, total) {
            const percent = Math.round((current / total) * 100);
            progressDiv.textContent = `ì§„í–‰ë¥ : ${current}/${total} (${percent}%)`;
        }
        
        // ê°„ë‹¨í•œ fetch ê¸°ë°˜ Supabase API í˜¸ì¶œ
        async function callSupabaseAPI(data) {
            const url = 'https://mtgicixejxtidvskoyqy.supabase.co/rest/v1/properties';
            const headers = {
                'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10Z2ljaXhlanh0aWR2c2tveXF5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc1Mzk5MTAsImV4cCI6MjA1MzExNTkxMH0.hQy3fPt-YWYZXOWOAjGlFGNkP2NnmSDUhHvjEHo9BZg',
                'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10Z2ljaXhlanh0aWR2c2tveXF5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc1Mzk5MTAsImV4cCI6MjA1MzExNTkxMH0.hQy3fPt-YWYZXOWOAjGlFGNkP2NnmSDUhHvjEHo9BZg',
                'Content-Type': 'application/json',
                'Prefer': 'return=minimal'
            };
            
            const response = await fetch(url, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(data)
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }
            
            return response;
        }
        
        async function startUpload() {
            try {
                updateStatus('ë°ì´í„° ë¡œë”© ì¤‘...');
                document.getElementById('startBtn').disabled = true;
                
                // ë°ì´í„° ë¡œë“œ
                addLog('ë§¤ë¬¼ ë°ì´í„°ë¥¼ GitHubì—ì„œ ë¡œë“œí•˜ëŠ” ì¤‘...');
                const response = await fetch('https://gma3561.github.io/the-realty-itemlist-dashboard/processed_properties.json');
                
                if (!response.ok) {
                    throw new Error(`ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${response.status}`);
                }
                
                const properties = await response.json();
                addLog(`âœ… ì´ ${properties.length}ê°œ ë§¤ë¬¼ ë°ì´í„° ë¡œë“œ ì™„ë£Œ`);
                
                // ë°°ì¹˜ ì—…ë¡œë“œ
                const BATCH_SIZE = 20; // ì‘ì€ ë°°ì¹˜ë¡œ ì‹œì‘
                let uploadedCount = 0;
                let failedCount = 0;
                
                updateStatus('ì—…ë¡œë“œ ì§„í–‰ ì¤‘...');
                
                for (let i = 0; i < properties.length; i += BATCH_SIZE) {
                    const batch = properties.slice(i, i + BATCH_SIZE);
                    const batchNum = Math.floor(i / BATCH_SIZE) + 1;
                    
                    try {
                        addLog(`ë°°ì¹˜ ${batchNum} ì—…ë¡œë“œ ì¤‘... (${batch.length}ê°œ)`);
                        updateProgress(i, properties.length);
                        
                        await callSupabaseAPI(batch);
                        
                        uploadedCount += batch.length;
                        addLog(`âœ… ë°°ì¹˜ ${batchNum} ì„±ê³µ (ì´ ${uploadedCount}ê°œ ì™„ë£Œ)`);
                        
                        // ì ì‹œ ëŒ€ê¸°
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                    } catch (error) {
                        failedCount += batch.length;
                        addLog(`âŒ ë°°ì¹˜ ${batchNum} ì‹¤íŒ¨: ${error.message}`);
                    }
                }
                
                updateProgress(properties.length, properties.length);
                updateStatus('ì—…ë¡œë“œ ì™„ë£Œ!');
                addLog(`\\nğŸ‰ ìµœì¢… ê²°ê³¼:`);
                addLog(`âœ… ì„±ê³µ: ${uploadedCount}ê°œ`);
                addLog(`âŒ ì‹¤íŒ¨: ${failedCount}ê°œ`);
                addLog(`ğŸ“Š ì „ì²´: ${properties.length}ê°œ`);
                
            } catch (error) {
                addLog(`ğŸ’¥ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
                updateStatus('ì—…ë¡œë“œ ì‹¤íŒ¨');
            } finally {
                document.getElementById('startBtn').disabled = false;
                document.getElementById('startBtn').textContent = 'ë‹¤ì‹œ ì‹œë„';
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ ìƒíƒœ ì—…ë°ì´íŠ¸
        window.addEventListener('load', () => {
            updateStatus('ì¤€ë¹„ ì™„ë£Œ - ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ ì‹œì‘');
            addLog('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
            addLog('ì—…ë¡œë“œí•  ë°ì´í„°: 763ê°œ ë§¤ë¬¼');
            addLog('ì—…ë¡œë“œ ë°©ì‹: 20ê°œì”© ë°°ì¹˜ ì²˜ë¦¬');
        });
    </script>
    
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1000px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f5f5f5;
        }
        h1 { 
            color: #333; 
            text-align: center;
        }
        #status { 
            font-size: 18px; 
            font-weight: bold; 
            margin: 20px 0; 
            padding: 10px;
            background: #fff;
            border-radius: 5px;
            border-left: 4px solid #007cba;
        }
        #progress { 
            font-size: 16px; 
            color: #666; 
            margin: 10px 0; 
            padding: 5px;
        }
        #log { 
            background: #fff; 
            border: 1px solid #ddd; 
            padding: 15px; 
            height: 500px; 
            overflow-y: scroll; 
            font-family: 'Courier New', monospace; 
            font-size: 12px;
            white-space: pre-wrap;
            border-radius: 5px;
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 20px 0;
        }
        button:hover {
            background: #005a87;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
    </style>
</body>
</html>