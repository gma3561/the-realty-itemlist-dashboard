# 🚨 긴급 수정사항 요약

**작성일**: 2025-08-03

## 실행해야 할 SQL 파일 (순서대로)

### 1. 타입 불일치 해결 ⚡
```bash
# Supabase SQL Editor에서 실행
긴급_타입불일치_완전수정.sql
```
- properties 테이블의 외래키 확인 및 수정
- property_type_id → property_type 변경
- UUID → TEXT 타입 변환
- CASCADE 없는 외래키 재생성

### 2. RLS 정책 수정 ⚡
```bash
# Supabase SQL Editor에서 실행
RLS_auth_uid_문제해결.sql
```
- auth_user_mappings 테이블 생성
- Google OAuth와 내부 시스템 연결
- 이메일 기반 권한 체크로 변경
- manager_id TEXT 타입으로 통일

### 3. Storage 버킷 생성 📦
**Supabase 대시보드에서**:
1. Storage → New bucket
2. Name: `property-images`
3. Public bucket: ✅ 체크

또는 SQL:
```sql
INSERT INTO storage.buckets (id, name, public) 
VALUES ('property-images', 'property-images', true);
```

### 4. 환경변수 설정 🔧
**.env 파일**:
```
VITE_ADMIN_EMAILS=admin@the-realty.co.kr,manager@the-realty.co.kr
```

## 핵심 변경사항

### 1. 데이터 타입 통일
- ❌ UUID 타입의 외래키
- ✅ TEXT 타입 ('apt', 'house' 등)

### 2. 권한 시스템
- ❌ auth.uid()와 users.id 직접 비교
- ✅ 이메일 기반 권한 확인

### 3. manager_id
- ❌ UUID 참조
- ✅ 이메일 문자열 저장

## 확인 방법

### 1. 타입 확인
```sql
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'properties' 
AND column_name IN ('property_type', 'transaction_type', 'property_status');
```

### 2. 매물 CRUD 테스트
- 매물 등록 시도
- 매물 수정 시도
- 이미지 업로드 시도

### 3. 권한 테스트
- 관리자 로그인 후 모든 기능 확인
- 일반 사용자 로그인 후 제한 확인

## 예상 결과

✅ 매물 CRUD 정상 작동
✅ 이미지 업로드 성공
✅ 권한 시스템 정상 작동
✅ 타입 에러 해결

---

**중요**: 위 SQL들을 순서대로 실행하면 기본 CRUD가 즉시 작동합니다.