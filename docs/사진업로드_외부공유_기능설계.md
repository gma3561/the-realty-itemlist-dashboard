# 사진 업로드 및 외부 공유 기능 설계

## 1. 사진 업로드 기능

### 1.1 기술 구현
```javascript
// Supabase Storage 활용
const uploadPropertyImages = async (propertyId, files) => {
  const uploads = files.map(async (file) => {
    const fileName = `${propertyId}/${Date.now()}_${file.name}`;
    const { data, error } = await supabase.storage
      .from('property-images')
      .upload(fileName, file, {
        cacheControl: '3600',
        upsert: false
      });
    
    // DB에 이미지 정보 저장
    if (data) {
      await supabase.from('property_images').insert({
        property_id: propertyId,
        file_path: data.path,
        file_name: file.name,
        file_size: file.size,
        uploaded_by: userId,
        display_order: index
      });
    }
  });
};
```

### 1.2 이미지 관리 테이블
```sql
CREATE TABLE property_images (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  property_id UUID REFERENCES properties(id) ON DELETE CASCADE,
  file_path TEXT NOT NULL,
  file_name TEXT,
  file_size INTEGER,
  display_order INTEGER DEFAULT 0,
  is_primary BOOLEAN DEFAULT false,
  uploaded_by UUID REFERENCES users(id),
  created_at TIMESTAMP DEFAULT NOW()
);
```

### 1.3 UI/UX 설계
- 드래그 앤 드롭 지원
- 다중 파일 업로드
- 이미지 순서 변경 (드래그로)
- 대표 이미지 설정
- 이미지 미리보기 및 삭제

## 2. 외부 공유 기능

### 2.1 공유 링크 생성 시스템
```javascript
// 공유 링크 생성
const createShareLink = async (propertyId, options = {}) => {
  const shareData = {
    property_id: propertyId,
    share_token: generateSecureToken(), // 보안 토큰 생성
    expires_at: options.expiresIn ? addDays(new Date(), options.expiresIn) : null,
    view_limit: options.viewLimit || null,
    hide_contact: options.hideContact !== false, // 기본값: 연락처 숨김
    hide_price: options.hidePrice || false,
    created_by: userId,
    view_count: 0
  };
  
  const { data } = await supabase
    .from('property_shares')
    .insert(shareData)
    .select()
    .single();
  
  // 공유 URL 생성
  const shareUrl = `${window.location.origin}/share/${data.share_token}`;
  return shareUrl;
};
```

### 2.2 공유 링크 테이블
```sql
CREATE TABLE property_shares (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  property_id UUID REFERENCES properties(id) ON DELETE CASCADE,
  share_token TEXT UNIQUE NOT NULL,
  expires_at TIMESTAMP,
  view_limit INTEGER,
  view_count INTEGER DEFAULT 0,
  hide_contact BOOLEAN DEFAULT true,
  hide_price BOOLEAN DEFAULT false,
  hide_owner_info BOOLEAN DEFAULT true,
  custom_message TEXT,
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMP DEFAULT NOW(),
  last_viewed_at TIMESTAMP
);

-- 공유 접속 로그
CREATE TABLE share_access_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  share_id UUID REFERENCES property_shares(id),
  ip_address TEXT,
  user_agent TEXT,
  accessed_at TIMESTAMP DEFAULT NOW()
);
```

### 2.3 공유 페이지 구현
```jsx
// 외부 공유 페이지 컴포넌트
const PropertySharePage = () => {
  const { token } = useParams();
  const [property, setProperty] = useState(null);
  const [images, setImages] = useState([]);
  
  useEffect(() => {
    // 토큰 검증 및 데이터 로드
    validateAndLoadProperty(token);
  }, [token]);
  
  return (
    <div className="share-page">
      {/* 로고 및 브랜딩 */}
      <header>
        <img src="/logo.png" alt="The Realty" />
      </header>
      
      {/* 매물 정보 (권한에 따라 일부 숨김) */}
      <PropertyInfo 
        property={property}
        hideContact={share.hide_contact}
        hidePrice={share.hide_price}
      />
      
      {/* 이미지 갤러리 */}
      <ImageGallery images={images} />
      
      {/* 문의하기 버튼 */}
      <ContactForm />
    </div>
  );
};
```

## 3. 보안 및 권한 관리

### 3.1 고객 정보 보호
```javascript
// RLS 정책 - 소유주 연락처는 담당자만
CREATE POLICY "owner_contact_policy" ON properties
FOR SELECT USING (
  -- 담당자이거나 관리자인 경우만 연락처 볼 수 있음
  auth.uid() = manager_id OR 
  auth.uid() IN (SELECT id FROM users WHERE role = 'admin')
);

// API에서 필드 필터링
const getPropertyForShare = async (token) => {
  const property = await getPropertyByShareToken(token);
  
  // 민감한 정보 제거
  delete property.owner_phone;
  delete property.owner_id_number;
  
  if (share.hide_contact) {
    delete property.manager_phone;
  }
  
  return property;
};
```

### 3.2 공유 링크 관리
```javascript
// 공유 링크 옵션
const shareOptions = {
  // 만료 기간
  expiresIn: 7, // 7일 후 만료
  
  // 조회 횟수 제한
  viewLimit: 100,
  
  // 숨길 정보 선택
  hideContact: true,    // 담당자 연락처 숨김
  hidePrice: false,     // 가격은 보임
  hideOwnerInfo: true,  // 소유주 정보 숨김
  
  // 커스텀 메시지
  customMessage: "이 매물에 관심 있으시면 연락 주세요"
};
```

## 4. 슬랙 알림 연동

### 4.1 웹훅 설정
```javascript
// 새 매물 등록 시 슬랙 알림
const notifySlack = async (property) => {
  const webhook = process.env.SLACK_WEBHOOK_URL;
  
  const message = {
    text: "🏠 새로운 매물이 등록되었습니다!",
    attachments: [{
      color: "good",
      fields: [
        { title: "매물명", value: property.property_name, short: true },
        { title: "위치", value: property.location, short: true },
        { title: "가격", value: formatPrice(property.price), short: true },
        { title: "담당자", value: property.manager_name, short: true }
      ],
      actions: [{
        type: "button",
        text: "매물 보기",
        url: `${BASE_URL}/properties/${property.id}`
      }]
    }]
  };
  
  await fetch(webhook, {
    method: 'POST',
    body: JSON.stringify(message)
  });
};
```

## 5. 구현 로드맵

### Phase 1 - 기본 기능 (1주)
- [ ] Supabase Storage 설정
- [ ] 이미지 업로드 API
- [ ] 이미지 갤러리 UI
- [ ] 기본 공유 링크 생성

### Phase 2 - 고급 기능 (1주)
- [ ] 공유 옵션 설정
- [ ] 외부 공유 페이지
- [ ] 접속 통계
- [ ] 슬랙 연동

### Phase 3 - 최적화 (3일)
- [ ] 이미지 리사이징
- [ ] 캐싱 최적화
- [ ] 보안 강화
- [ ] 분석 대시보드

## 6. 예상 효과

1. **영업 효율성 향상**
   - 고객에게 즉시 매물 정보 전달
   - 전문적인 프레젠테이션

2. **보안성 확보**
   - 민감한 정보는 숨기고 필요한 정보만 공유
   - 공유 링크 통제 가능

3. **팀 협업 강화**
   - 슬랙으로 실시간 알림
   - 누가 어떤 매물을 공유했는지 추적

4. **고객 경험 개선**
   - 모바일 최적화된 공유 페이지
   - 깔끔한 이미지 갤러리