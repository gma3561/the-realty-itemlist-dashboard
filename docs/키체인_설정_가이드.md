# macOS 키체인 기반 API 키 관리 가이드

## 📋 개요

The Realty Dashboard는 보안을 위해 Google Drive API 키를 macOS 키체인에 안전하게 저장합니다.

## 🔐 키체인 관리 명령어

### 1. 키 설정
```bash
npm run keychain setup
```
- Google Drive API 키를 대화형으로 입력받아 키체인에 저장

### 2. 상태 확인
```bash
npm run keychain status
```
- 현재 키체인에 저장된 키들의 상태 확인

### 3. 연결 테스트
```bash
npm run keychain test
```
- 키체인에서 키를 불러와 Google Drive 연결 테스트

### 4. 키 삭제
```bash
npm run keychain clear
```
- 모든 API 키를 키체인에서 삭제

## 🚀 초기 설정 과정

### 1. Google Cloud Console 설정

1. [Google Cloud Console](https://console.cloud.google.com/) 접속
2. 새 프로젝트 생성 또는 기존 프로젝트 선택
3. Google Drive API 활성화
4. 서비스 계정 생성:
   - IAM 및 관리자 > 서비스 계정
   - "서비스 계정 만들기" 클릭
   - 이름: `the-realty-drive-service`
   - 역할: Editor 또는 필요한 최소 권한
5. 서비스 계정 키 생성:
   - 생성된 서비스 계정 클릭
   - "키" 탭 > "키 추가" > "새 키 만들기"
   - 유형: JSON 선택
   - 다운로드된 JSON 파일 확인

### 2. Google Drive 폴더 설정

1. Google Drive에서 루트 폴더 생성:
   ```
   팀 매물장/
   ├── 2024-01/
   ├── 2024-02/
   └── shared-links/
   ```

2. 폴더 ID 확인:
   - 폴더 우클릭 > "링크 가져오기"
   - URL에서 폴더 ID 추출: `https://drive.google.com/drive/folders/[FOLDER_ID]`

3. 서비스 계정에 권한 부여:
   - 각 폴더 우클릭 > "공유"
   - 서비스 계정 이메일 추가 (편집자 권한)

### 3. 키체인에 키 저장

```bash
npm run keychain setup
```

다음 정보를 입력하세요:
- **Google 서비스 계정 이메일**: JSON 파일의 `client_email`
- **Google Private Key**: JSON 파일의 `private_key` (전체 텍스트)
- **Google Project ID**: JSON 파일의 `project_id`
- **Google Drive 루트 폴더 ID**: 메인 폴더의 ID
- **Google Drive 공유 폴더 ID**: shared-links 폴더의 ID

### 4. 설정 확인

```bash
npm run keychain status
```

모든 키가 ✅로 표시되어야 합니다:
```
📋 저장된 키 현황:
  ✅ GOOGLE_CLIENT_EMAIL
  ✅ GOOGLE_PRIVATE_KEY
  ✅ GOOGLE_PROJECT_ID
  ✅ GOOGLE_DRIVE_ROOT_FOLDER_ID
  ✅ GOOGLE_DRIVE_SHARE_FOLDER_ID
```

### 5. 연결 테스트

```bash
npm run keychain test
```

성공하면 다음과 같이 표시됩니다:
```
🧪 Google Drive 연결 테스트...
✅ 키체인에서 설정을 성공적으로 불러왔습니다
📧 클라이언트 이메일: your-service@project.iam.gserviceaccount.com
🆔 프로젝트 ID: your-project-id
📁 루트 폴더 ID: 1234567890abcdef
🔗 공유 폴더 ID: abcdef1234567890
```

## 🔒 보안 특징

### 키체인 보안
- API 키가 코드나 환경변수 파일에 노출되지 않음
- macOS 키체인의 암호화된 저장소 활용
- 시스템 비밀번호로 보호됨

### 접근 제어
- 서비스별 키 분리 저장
- 개별 키 삭제 가능
- 키 존재 여부만 확인 가능 (값 노출 안됨)

## 🛠 문제 해결

### 키체인 접근 오류
```bash
# 키체인 권한 재설정
security unlock-keychain ~/Library/Keychains/login.keychain-db
```

### 구글 드라이브 권한 오류
1. 서비스 계정이 폴더에 접근 권한이 있는지 확인
2. Google Drive API가 프로젝트에서 활성화되었는지 확인
3. 서비스 계정 키가 활성 상태인지 확인

### 키 값 확인
```bash
# 특정 키 값 확인 (디버깅용)
security find-generic-password -a "GOOGLE_CLIENT_EMAIL" -s "the-realty-dashboard" -w
```

## 📚 참고사항

### 환경변수 vs 키체인
- 개발 환경: 키체인 사용 (보안성)
- 배포 환경: Vercel/Netlify 환경변수 사용
- CI/CD: GitHub Secrets 사용

### 백업 및 복원
키체인 데이터는 macOS 백업에 포함되지만, 별도 백업 권장:
1. JSON 키 파일을 안전한 곳에 보관
2. 필요시 `npm run keychain setup`으로 재설정

### 팀 공유
각 개발자는 개별적으로 키체인 설정 필요:
1. 동일한 서비스 계정 JSON 파일 공유 (보안 채널 통해)
2. 각자 `npm run keychain setup` 실행