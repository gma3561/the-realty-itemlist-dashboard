<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìë™ ë°ì´í„° ì—…ë¡œë“œ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Supabase ìë™ ë°ì´í„° ì—…ë¡œë“œ</h1>
    <div id="status">ì¤€ë¹„ ì¤‘...</div>
    <div id="progress"></div>
    <div id="log"></div>

    <script>
        // Supabase ì„¤ì •
        const SUPABASE_URL = 'https://mtgicixejxtidvskoyqy.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10Z2ljaXhlanh0aWR2c2tveXF5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc1Mzk5MTAsImV4cCI6MjA1MzExNTkxMH0.hQy3fPt-YWYZXOWOAjGlFGNkP2NnmSDUhHvjEHo9BZg';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        const statusDiv = document.getElementById('status');
        const progressDiv = document.getElementById('progress');
        const logDiv = document.getElementById('log');
        
        function log(message) {
            console.log(message);
            logDiv.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateStatus(message) {
            statusDiv.textContent = message;
        }
        
        function updateProgress(current, total) {
            progressDiv.textContent = `ì§„í–‰ìƒí™©: ${current}/${total} (${Math.round(current/total*100)}%)`;
        }
        
        async function uploadPropertiesToSupabase() {
            try {
                updateStatus('ë°ì´í„° ë¡œë“œ ì¤‘...');
                log('ğŸš€ ë§¤ë¬¼ ë°ì´í„° ì—…ë¡œë“œ ì‹œì‘');
                
                // GitHubì—ì„œ ë°ì´í„° ë¡œë“œ
                const response = await fetch('https://gma3561.github.io/the-realty-itemlist-dashboard/processed_properties.json');
                if (!response.ok) {
                    throw new Error('ë°ì´í„° íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
                
                const allProperties = await response.json();
                log(`ğŸ“Š ì´ ${allProperties.length}ê°œ ë§¤ë¬¼ ë°ì´í„° ë¡œë“œ ì™„ë£Œ`);
                
                // ë°°ì¹˜ ë‹¨ìœ„ë¡œ ì—…ë¡œë“œ
                const BATCH_SIZE = 30;
                let uploadedCount = 0;
                let failedCount = 0;
                const errors = [];
                
                updateStatus('ì—…ë¡œë“œ ì§„í–‰ ì¤‘...');
                
                for (let i = 0; i < allProperties.length; i += BATCH_SIZE) {
                    const batch = allProperties.slice(i, i + BATCH_SIZE);
                    const batchNumber = Math.floor(i / BATCH_SIZE) + 1;
                    
                    try {
                        log(`ğŸ“¤ ë°°ì¹˜ ${batchNumber} ì—…ë¡œë“œ ì¤‘... (${batch.length}ê°œ ë§¤ë¬¼)`);
                        updateProgress(i, allProperties.length);
                        
                        const { data, error } = await supabase
                            .from('properties')
                            .insert(batch)
                            .select();
                            
                        if (error) throw error;
                        
                        uploadedCount += batch.length;
                        log(`âœ… ë°°ì¹˜ ${batchNumber} ì™„ë£Œ: ${batch.length}ê°œ ì—…ë¡œë“œ (ì´ ${uploadedCount}ê°œ)`);
                        
                        // ë°°ì¹˜ ê°„ ì ì‹œ ëŒ€ê¸°
                        if (i + BATCH_SIZE < allProperties.length) {
                            await new Promise(resolve => setTimeout(resolve, 200));
                        }
                        
                    } catch (batchError) {
                        log(`âŒ ë°°ì¹˜ ${batchNumber} ì‹¤íŒ¨: ${batchError.message}`);
                        failedCount += batch.length;
                        errors.push(`ë°°ì¹˜ ${batchNumber}: ${batchError.message}`);
                    }
                }
                
                // ìµœì¢… ê²°ê³¼
                updateStatus('ì—…ë¡œë“œ ì™„ë£Œ!');
                updateProgress(allProperties.length, allProperties.length);
                
                log(`\\nğŸ‰ ì—…ë¡œë“œ ì™„ë£Œ!`);
                log(`âœ… ì„±ê³µ: ${uploadedCount}ê°œ`);
                log(`âŒ ì‹¤íŒ¨: ${failedCount}ê°œ`);
                
                if (errors.length > 0) {
                    log('âŒ ì˜¤ë¥˜ ëª©ë¡:');
                    errors.forEach(error => log(`  - ${error}`));
                }
                
                // ê±°ë˜ìœ í˜•ë³„ í†µê³„
                const stats = {
                    sale: allProperties.filter(p => p.transaction_type === 'sale').length,
                    lease: allProperties.filter(p => p.transaction_type === 'lease').length,
                    rent: allProperties.filter(p => p.transaction_type === 'rent').length
                };
                
                log(`\\nğŸ“ˆ ì—…ë¡œë“œëœ ë§¤ë¬¼ í†µê³„:`);
                log(`- ë§¤ë§¤: ${stats.sale}ê°œ`);
                log(`- ì „ì„¸: ${stats.lease}ê°œ`);
                log(`- ì›”ì„¸: ${stats.rent}ê°œ`);
                
                return {
                    total: allProperties.length,
                    uploaded: uploadedCount,
                    failed: failedCount,
                    errors: errors
                };
                
            } catch (error) {
                log(`ğŸ’¥ ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
                updateStatus('ì—…ë¡œë“œ ì‹¤íŒ¨');
                throw error;
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œì‹œ ìë™ ì‹¤í–‰
        window.addEventListener('load', () => {
            setTimeout(() => {
                uploadPropertiesToSupabase();
            }, 1000);
        });
    </script>
    
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        #status { 
            font-size: 18px; 
            font-weight: bold; 
            margin: 20px 0; 
        }
        #progress { 
            font-size: 16px; 
            color: #666; 
            margin: 10px 0; 
        }
        #log { 
            background: #f5f5f5; 
            border: 1px solid #ddd; 
            padding: 10px; 
            height: 400px; 
            overflow-y: scroll; 
            font-family: monospace; 
            font-size: 12px; 
        }
        #log div { 
            margin: 2px 0; 
        }
    </style>
</body>
</html>